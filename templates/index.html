<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente de Procesamiento de Facturas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .report-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .report-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .financial-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .financial-box p {
            margin: 8px 0;
            font-size: 1.1rem;
        }

        .violations-box {
            background: #ffebee;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            margin: 15px 0;
        }

        .violations-box h4 {
            color: #f44336;
            margin-bottom: 10px;
        }

        .details-table {
            width: 100%;
            margin-top: 20px;
            overflow-x: auto;
        }

        .details-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .details-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .details-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .details-table tr:hover {
            background: #f5f5f5;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.valid {
            background: #e8f5e9;
            color: #4CAF50;
        }

        .status-badge.invalid {
            background: #ffebee;
            color: #f44336;
        }

        .accuracy-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
            </div>
            <h1>Agente de Procesamiento de Facturas</h1>
            <p class="subtitle">Procesamiento inteligente y validaci√≥n autom√°tica de facturas con IA</p>
        </header>

        <div class="card">
            <form id="invoiceForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="limitations">
                        <strong>Limitaciones de Facturas</strong>
                        <span class="help-text">Define las reglas de validaci√≥n (ej: "Solo alimentos, m√°ximo 50000 CRC")</span>
                    </label>
                    <textarea
                        id="limitations"
                        name="limitations"
                        rows="4"
                        placeholder="Ejemplo: Solo art√≠culos de comida y bebida. Monto m√°ximo: 100,000 colones (CRC). No alcohol ni productos de tabaco."
                        required
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="invoices">
                        <strong>Cargar Facturas</strong>
                        <span class="help-text">Formatos soportados: PDF, PNG, JPG, XML (M√∫ltiples archivos permitidos)</span>
                    </label>
                    <div class="file-upload-wrapper">
                        <input
                            type="file"
                            id="invoices"
                            name="invoices"
                            multiple
                            accept=".pdf,.png,.jpg,.jpeg,.xml"
                            required
                        >
                        <div id="fileList" class="file-list"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">
                        <strong>Correo Electr√≥nico</strong>
                        <span class="help-text">El reporte ser√° enviado a este correo</span>
                    </label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        placeholder="tu.correo@ejemplo.com"
                        required
                    >
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">
                    <span id="btnText">Procesar Facturas</span>
                    <span id="btnLoader" class="loader" style="display: none;"></span>
                </button>
            </form>
        </div>

        <div id="result" class="result" style="display: none;">
            <div id="resultContent"></div>
        </div>

        <footer>
            <p>Powered by OpenAI API | Desarrollado con Flask y Python</p>
            <p class="footer-small">¬© 2024 Agente de Procesamiento de Facturas</p>
        </footer>
    </div>

    <script>
        const form = document.getElementById('invoiceForm');
        const fileInput = document.getElementById('invoices');
        const fileList = document.getElementById('fileList');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');
        const result = document.getElementById('result');
        const resultContent = document.getElementById('resultContent');

        // Mostrar archivos seleccionados
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                fileList.innerHTML = '<strong>Archivos seleccionados:</strong><ul>' +
                    files.map(f => `<li>${f.name} (${(f.size / 1024).toFixed(2)} KB)</li>`).join('') +
                    '</ul>';
            } else {
                fileList.innerHTML = '';
            }
        });

        // Env√≠o del formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Mostrar estado de carga
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            result.style.display = 'none';

            // Preparar datos del formulario
            const formData = new FormData(form);

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const emailStatus = data.email_sent
                        ? '‚úÖ Reporte enviado a tu correo electr√≥nico'
                        : '‚ö†Ô∏è El env√≠o de correo fall√≥, pero puedes ver el reporte aqu√≠';

                    // Construir reporte detallado
                    let reportHTML = `
                        <div class="success-message">
                            <h3>‚úì ¬°Procesamiento Completado!</h3>
                            <p>${data.message}</p>

                            <div class="accuracy-info">
                                <strong>üìä Precisi√≥n de Detecci√≥n:</strong> ${data.summary.accuracy}%
                                <p style="margin-top: 5px; font-size: 0.9rem; opacity: 0.8;">
                                    La precisi√≥n indica qu√© tan exactas fueron las validaciones realizadas por el sistema
                                </p>
                            </div>

                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="summary-label">Total Procesadas</span>
                                    <span class="summary-value">${data.summary.total_processed}</span>
                                </div>
                                <div class="summary-item success">
                                    <span class="summary-label">V√°lidas</span>
                                    <span class="summary-value">${data.summary.valid_invoices}</span>
                                </div>
                                <div class="summary-item error">
                                    <span class="summary-label">Inv√°lidas</span>
                                    <span class="summary-value">${data.summary.invalid_invoices}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Precisi√≥n</span>
                                    <span class="summary-value">${data.summary.accuracy}%</span>
                                </div>
                            </div>

                            <p class="email-notice">${emailStatus}</p>
                        </div>

                        <div class="report-section">
                            <h3>üí∞ Resumen Financiero</h3>
                            <div class="financial-box">
                                <p><strong>Monto Aprobado:</strong> ${data.report.currency} ${parseFloat(data.report.total_approved_amount).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <p><strong>Monto Excluido:</strong> ${data.report.currency} ${parseFloat(data.report.total_excluded_amount).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <p><strong>L√≠mite M√°ximo:</strong> ${data.report.currency} ${parseFloat(data.report.max_limit).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            </div>
                        </div>
                    `;

                    // Agregar violaciones si existen
                    if (data.report.violations && data.report.violations.length > 0) {
                        reportHTML += `
                            <div class="report-section">
                                <div class="violations-box">
                                    <h4>‚ö†Ô∏è Violaciones Encontradas</h4>
                                    <ul>
                                        ${data.report.violations.map(v => `<li>${v}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }

                    // Agregar tabla de detalles
                    reportHTML += `
                        <div class="report-section">
                            <h3>üìã Detalles de Facturas</h3>
                            <div class="details-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Proveedor</th>
                                            <th>N¬∞ Factura</th>
                                            <th>Monto Total</th>
                                            <th>Fecha</th>
                                            <th>Moneda</th>
                                            <th>Estado</th>
                                            <th>Problemas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    data.report.detailed_results.forEach((result, index) => {
                        const statusBadge = result.is_valid
                            ? '<span class="status-badge valid">‚úì V√°lida</span>'
                            : '<span class="status-badge invalid">‚úó Inv√°lida</span>';

                        const issues = result.violations && result.violations.length > 0
                            ? result.violations.join(', ')
                            : 'Ninguno';

                        reportHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${result.supplier_name || 'Desconocido'}</td>
                                <td>${result.invoice_number || 'N/A'}</td>
                                <td>${parseFloat(result.total_amount || 0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td>${result.date || 'N/A'}</td>
                                <td>${result.currency || 'N/A'}</td>
                                <td>${statusBadge}</td>
                                <td>${issues}</td>
                            </tr>
                        `;
                    });

                    reportHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    resultContent.innerHTML = reportHTML;
                    result.className = 'result success';
                    form.reset();
                    fileList.innerHTML = '';

                    // Scroll al reporte
                    setTimeout(() => {
                        result.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    resultContent.innerHTML = `
                        <div class="error-message">
                            <h3>‚úó Error</h3>
                            <p>${data.error || 'Ocurri√≥ un error al procesar las facturas'}</p>
                        </div>
                    `;
                    result.className = 'result error';
                }

                result.style.display = 'block';

            } catch (error) {
                resultContent.innerHTML = `
                    <div class="error-message">
                        <h3>‚úó Error de Conexi√≥n</h3>
                        <p>No se pudo conectar al servidor. Por favor intenta de nuevo.</p>
                    </div>
                `;
                result.className = 'result error';
                result.style.display = 'block';
            } finally {
                // Resetear estado del bot√≥n
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        });
    </script>
</body>
</html>
